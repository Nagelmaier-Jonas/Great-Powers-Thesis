@using Domain.Services
@using Model.Entities
@using Domain.Repositories
@inject DockerService DockerService
@inject NavigationManager NavigationManager
@inject FileService FileService

@foreach (var container in DockerContainers){
    <MudCard Outlined="true">
        <MudCardContent>
            <MudText>@container</MudText>
            <MudText>@Infos[container].Round</MudText>
            <MudText>@Infos[container].Phase.ToString()</MudText>
        </MudCardContent>
        <MudCardActions>
            <MudButton OnClick="@(() => LoadSession(container, "127.0.0.1", DockerService.GetPortMySql().ToString(), DockerService.GetPortRabbitMqS().ToString(), DockerService.GetPortRabbitMqW().ToString()))">Load</MudButton>
        </MudCardActions>
    </MudCard>
}

@code {

    [Parameter]
    public List<string> DockerContainers { get; set; }

    private Dictionary<string,SessionInfo> Infos { get; set; } = new();
    
    protected override void OnInitialized(){
        foreach (var container in DockerContainers){
            Infos.Add(container,FileService.ReadSessionInfoFromFile(container));
        }
    }

    private async Task LoadSession(string name, string ipAddress, string portmySql,string portRabbitMqS,string portRabbitMqW){
        await DockerService.StartDockerContainer(name, portmySql, portRabbitMqS, portRabbitMqW);
        while (!DockerService.CheckConnection($"{ipAddress}", portmySql)){
        }
        await DockerService.ChangeDbContext($"{ipAddress}", portmySql, portRabbitMqS, portRabbitMqW);
        NavigationManager.NavigateTo("/game");
    }

}